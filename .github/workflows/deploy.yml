name: Deploy to Lighthouse

on:
  push:
    branches: [ "main" ]
  repository_dispatch:
    types: [frontend-update]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,format=short

      - name: Lowercase Image Name
        id: image_name
        run: |
          echo "IMAGE_LOWER=$(echo ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_LOWER }}:latest
          labels: ${{ steps.meta.outputs.labels }}

  build-and-push-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Frontend Repository
        uses: actions/checkout@v3
        with:
          repository: iWuxc/omiai-miniapp # 替换为您实际的前端仓库名称
          path: omiai-miniapp            # 检出到当前工作区的 omiai-miniapp 目录
          # 如果是私有仓库，需要配置 token
          # token: ${{ secrets.GH_PAT }} 

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Lowercase Image Name
        id: image_name
        run: |
          echo "IMAGE_LOWER=$(echo ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and push Frontend Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./omiai-miniapp  # 现在这个目录存在了
          push: true
          tags: ${{ env.IMAGE_LOWER }}-web:latest
          build-args: |
            VITE_API_BASE_URL=http://www.omiai.cn/api
            VITE_H5_DOMAIN=http://www.omiai.cn/#
            VITE_ASSETS_URL=http://www.omiai.cn

  deploy:
    needs: [build-and-push-backend, build-and-push-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Set Lowercase Image Name
        run: |
          echo "IMAGE_LOWER=$(echo ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Deploy to Lighthouse via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 配置 Docker 镜像加速 (腾讯云内网源)
            if [ ! -f /etc/docker/daemon.json ] || ! grep -q "registry-mirrors" /etc/docker/daemon.json; then
              echo '{"registry-mirrors": ["https://mirror.ccs.tencentyun.com"], "log-driver": "json-file", "log-opts": {"max-size": "10m", "max-file": "3"}}' > /etc/docker/daemon.json
              systemctl daemon-reload
              systemctl restart docker
            fi

            # 登录 GHCR
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 创建部署目录
            mkdir -p /data/omiai-server/deploy
            cd /data/omiai-server
            
            # 创建或更新 docker-compose.prod.yml
            cat > deploy/docker-compose.prod.yml <<EOF
            version: '3.8'
            services:
              server:
                image: ${{ env.IMAGE_LOWER }}:latest
                container_name: omiai-server
                restart: always
                ports:
                  - "10131:10131"
                  - "10132:10132"
                  - "10133:10133"
                environment:
                  - APP_ENV=prod
                  - DEBUG=false
                  - ENABLE_CRON=true
                  - LOG_LEVEL=info
                  - STORAGE_DRIVER=\${STORAGE_DRIVER}
                  - TZ=Asia/Shanghai
                  - DB_HOST=mysql
                  - DB_PORT=3306
                  - DB_USER=root
                  - DB_DEBUG=false
                  - DB_PASSWORD=\${DB_PASSWORD}
                  - DB_NAME=omiai
                  - REDIS_HOST=redis
                  - REDIS_PORT=6379
                  - REDIS_PASSWORD=\${REDIS_PASSWORD}
                  - ZHIPUAI_API_KEY=\${ZHIPUAI_API_KEY}
                  - ZHIPUAI_MODEL=glm-4-flash
                  - DOMAIN_H5=\${DOMAIN_H5}
                  - OSS_ENDPOINT=
                  - OSS_ACCESS_KEY_ID=
                  - OSS_ACCESS_KEY_SECRET=
                  - OSS_BUCKET_NAME=
                  - OSS_DOMAIN=
                  - COS_BUCKET_URL=${{ secrets.COS_BUCKET_URL }}
                  - COS_REGION=${{ secrets.COS_REGION }}
                  - COS_SECRET_ID=${{ secrets.COS_SECRET_ID }}
                  - COS_SECRET_KEY=${{ secrets.COS_SECRET_KEY }}
                depends_on:
                  - mysql
                  - redis
                volumes:
                  - ./runtime/logs:/app/runtime/logs
                logging:
                  driver: "json-file"
                  options:
                    max-size: "10m"
                    max-file: "3"
            
              frontend:
                image: ${{ env.IMAGE_LOWER }}-web:latest
                container_name: omiai-frontend
                restart: always
                ports:
                  - "10080:80"
                logging:
                  driver: "json-file"
                  options:
                    max-size: "10m"
                    max-file: "3"

              mysql:
                image: mysql:8.0
                container_name: omiai-mysql
                restart: always
                environment:
                  MYSQL_ROOT_PASSWORD: \${DB_PASSWORD}
                  MYSQL_DATABASE: omiai
                ports:
                  - "13018:3306"
                volumes:
                  - mysql_data:/var/lib/mysql
                  - ./doc/sql/omiai.sql:/docker-entrypoint-initdb.d/init.sql
                logging:
                  driver: "json-file"
                  options:
                    max-size: "10m"
                    max-file: "3"
            
              redis:
                image: redis:6.2
                container_name: omiai-redis
                restart: always
                command: redis-server --requirepass \${REDIS_PASSWORD}
                ports:
                  - "6379:6379"
                volumes:
                  - redis_data:/data
                logging:
                  driver: "json-file"
                  options:
                    max-size: "10m"
                    max-file: "3"
            
            volumes:
              mysql_data:
              redis_data:
            EOF
            
            # 创建 .env 文件 (从 GitHub Secrets 获取)
            cat > deploy/.env <<EOF
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=${{ secrets.DB_NAME }}
            REDIS_HOST=${{ secrets.REDIS_HOST }}
            REDIS_PORT=${{ secrets.REDIS_PORT }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            ZHIPUAI_API_KEY=${{ secrets.ZHIPUAI_API_KEY }}
            DOMAIN_H5=${{ secrets.DOMAIN_H5 }}
            STORAGE_DRIVER=${{ secrets.STORAGE_DRIVER }}
            COS_BUCKET_URL=${{ secrets.COS_BUCKET_URL }}
            COS_REGION=${{ secrets.COS_REGION }}
            COS_SECRET_ID=${{ secrets.COS_SECRET_ID }}
            COS_SECRET_KEY=${{ secrets.COS_SECRET_KEY }}
            EOF
            
            # 拉取最新镜像
            docker pull ${{ env.IMAGE_LOWER }}:latest
            docker pull ${{ env.IMAGE_LOWER }}-web:latest
            
            # 启动服务
            cd deploy
            docker compose -f docker-compose.prod.yml up -d
            
            # 清理旧镜像
            docker image prune -f
