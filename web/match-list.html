<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>情侣管理 - 红娘助手</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vant@4/lib/index.css"/>
    <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { background-color: #f7f8fa; padding-bottom: 60px; }
        .search-section { background: #fff; padding: 12px 16px; }
        .match-list { padding: 16px; }
        .match-card { background: #fff; border-radius: 12px; margin-bottom: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .couple-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .person { display: flex; align-items: center; gap: 10px; flex: 1; }
        .person-avatar { width: 48px; height: 48px; border-radius: 50%; }
        .person-info { display: flex; flex-direction: column; gap: 4px; }
        .person-name { font-size: 15px; font-weight: 600; color: #323233; }
        .person-detail { font-size: 12px; color: #969799; }
        .heart-icon { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .heart-icon .van-icon { color: #ee0a24; }
        .match-score { font-size: 14px; font-weight: 600; color: #ee0a24; }
        .match-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid #f7f8fa; }
        .match-date { font-size: 12px; color: #969799; }
    </style>
</head>
<body>
    <div id="app">
        <van-nav-bar title="情侣管理" left-arrow @click-left="goBack"></van-nav-bar>

        <div class="search-section">
            <van-search v-model="keyword" placeholder="搜索姓名" @search="onSearch" :show-action="false"></van-search>
            <van-tabs v-model:active="currentTab" @change="onTabChange" color="#ee0a24">
                <van-tab title="全部" name="0"></van-tab>
                <van-tab title="相识" name="1"></van-tab>
                <van-tab title="交往" name="2"></van-tab>
                <van-tab title="稳定" name="3"></van-tab>
                <van-tab title="订婚" name="4"></van-tab>
                <van-tab title="结婚" name="5"></van-tab>
                <van-tab title="分手" name="6"></van-tab>
            </van-tabs>
        </div>

        <div class="match-list">
            <div v-if="loading" style="text-align: center; padding: 40px;">
                <van-loading size="24px">加载中...</van-loading>
            </div>
            <div v-else-if="matchList.length === 0" style="text-align: center; padding: 40px; color: #999;">
                <van-empty description="暂无匹配记录"></van-empty>
            </div>
            <div v-else>
                <div class="match-card" v-for="item in matchList" :key="item.id" @click="goDetail(item.id)">
                    <div class="couple-header">
                        <div class="person">
                            <van-image class="person-avatar" round :src="item.male_client?.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${item.male_client_id}`"></van-image>
                            <div class="person-info">
                                <span class="person-name">{{ item.male_client?.name }}</span>
                                <span class="person-detail">{{ item.male_client?.age }}岁 | {{ item.male_client?.profession || '未知职业' }}</span>
                            </div>
                        </div>
                        <div class="heart-icon">
                            <van-icon name="heart" size="24"></van-icon>
                            <span class="match-score">{{ item.match_score }}分</span>
                        </div>
                        <div class="person" style="justify-content: flex-end;">
                            <div class="person-info" style="align-items: flex-end;">
                                <span class="person-name">{{ item.female_client?.name }}</span>
                                <span class="person-detail">{{ item.female_client?.age }}岁 | {{ item.female_client?.profession || '未知职业' }}</span>
                            </div>
                            <van-image class="person-avatar" round :src="item.female_client?.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${item.female_client_id}`"></van-image>
                        </div>
                    </div>
                    <div class="match-footer">
                        <span class="match-date">{{ formatDate(item.match_date) }} 匹配</span>
                        <van-tag :type="getStatusType(item.status)">{{ getStatusText(item.status) }}</van-tag>
                    </div>
                </div>
                <van-loading v-if="loadingMore" size="24px" style="text-align: center; padding: 16px;">加载中...</van-loading>
                <div v-if="!hasMore && matchList.length > 0" style="text-align: center; padding: 16px; color: #999; font-size: 12px;">没有更多了</div>
            </div>
        </div>

        <van-tabbar v-model="active" active-color="#ee0a24">
            <van-tabbar-item icon="home-o" url="index.html">工作台</van-tabbar-item>
            <van-tabbar-item icon="friends-o" url="client-list.html">客户池</van-tabbar-item>
            <van-tabbar-item icon="like-o">情侣</van-tabbar-item>
            <van-tabbar-item icon="chat-o" url="templates.html">话术</van-tabbar-item>
        </van-tabbar>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const active = ref(2);
                const keyword = ref('');
                const currentTab = ref('0');
                const matchList = ref([]);
                const loading = ref(false);
                const loadingMore = ref(false);
                const hasMore = ref(true);
                const page = ref(1);
                const pageSize = 10;

                const token = localStorage.getItem('token');
                const api = axios.create({
                    baseURL: '/api',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                const getStatusText = (status) => {
                    const map = { 1: '相识', 2: '交往', 3: '稳定', 4: '订婚', 5: '结婚', 6: '分手' };
                    return map[status] || '未知';
                };

                const getStatusType = (status) => {
                    const map = { 1: 'primary', 2: 'warning', 3: 'success', 4: 'success', 5: 'success', 6: 'info' };
                    return map[status] || 'default';
                };

                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    return dateStr.split('T')[0];
                };

                const fetchData = async (reset = false) => {
                    if (reset) {
                        page.value = 1;
                        matchList.value = [];
                        hasMore.value = true;
                    }

                    if (!hasMore.value) return;

                    loadingMore.value = page.value === 1;

                    try {
                        const params = {
                            page: page.value,
                            page_size: pageSize,
                            status: currentTab.value === '0' ? undefined : parseInt(currentTab.value),
                            keyword: keyword.value || undefined
                        };

                        const res = await api.get('/couples/list', { params });
                        const list = res.data.data?.list || [];

                        if (list.length < pageSize) {
                            hasMore.value = false;
                        }

                        if (reset) {
                            matchList.value = list;
                        } else {
                            matchList.value = [...matchList.value, ...list];
                        }
                        page.value++;
                    } catch (e) {
                        console.error(e);
                    } finally {
                        loading.value = false;
                        loadingMore.value = false;
                    }
                };

                const onSearch = () => {
                    fetchData(true);
                };

                const onTabChange = () => {
                    fetchData(true);
                };

                const goDetail = (id) => {
                    window.location.href = `match-detail.html?id=${id}`;
                };

                const goBack = () => {
                    window.history.back();
                };

                const handleScroll = () => {
                    const scrollTop = window.scrollY;
                    const windowHeight = window.innerHeight;
                    const documentHeight = document.documentElement.scrollHeight;

                    if (scrollTop + windowHeight >= documentHeight - 100) {
                        if (!loadingMore.value && hasMore.value) {
                            fetchData();
                        }
                    }
                };

                onMounted(() => {
                    fetchData();
                    window.addEventListener('scroll', handleScroll);
                });

                return {
                    active,
                    keyword,
                    currentTab,
                    matchList,
                    loading,
                    loadingMore,
                    hasMore,
                    getStatusText,
                    getStatusType,
                    formatDate,
                    onSearch,
                    onTabChange,
                    goDetail,
                    goBack
                };
            }
        }).use(vant).mount('#app');
    </script>
</body>
</html>
