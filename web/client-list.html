<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>客户资源池 - 红娘助手</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vant@4/lib/index.css"/>
    <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { background-color: #f7f8fa; padding-bottom: 60px; }
        .header { position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: #fff; box-shadow: 0 2px 12px rgba(0,0,0,0.05); }
        .search-section { padding: 12px 16px; display: flex; gap: 8px; }
        .filter-btn { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 6px 12px; background: #fff0f2; border-radius: 8px; }
        .filter-btn span { font-size: 10px; color: #ee0a24; }
        .tab-section { padding: 0 16px 8px; }
        .client-list { padding: 16px; margin-top: 130px; }
        .client-card { background: #fff; border-radius: 12px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .card-header { position: relative; height: 140px; }
        .card-header img { width: 100%; height: 100%; object-fit: cover; }
        .status-badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: #fff; padding: 4px 10px; border-radius: 12px; font-size: 11px; }
        .gender-dot { position: absolute; top: 10px; right: 10px; width: 8px; height: 8px; border-radius: 50%; }
        .gender-dot.male { background: #4a90e2; }
        .gender-dot.female { background: #ff5e78; }
        .card-body { padding: 14px; }
        .name-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .name { font-size: 16px; font-weight: 600; color: #323233; }
        .info-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; }
        .mini-tag { font-size: 11px; padding: 3px 8px; border-radius: 4px; background: #f7f8fa; color: #969799; }
        .profession { font-size: 12px; color: #c8c9cc; }
        .filter-popup .van-popup__body { height: calc(100vh - 54px); }
        .filter-content { padding: 16px; }
        .filter-group { margin-bottom: 20px; }
        .filter-title { font-size: 14px; font-weight: 600; color: #323233; margin-bottom: 12px; }
        .tag-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .tag-item { padding: 6px 14px; background: #f7f8fa; border-radius: 4px; font-size: 13px; color: #646566; cursor: pointer; }
        .tag-item.active { background: #fff0f2; color: #ee0a24; }
        .range-box { display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="search-section">
                <van-search v-model="keyword" placeholder="搜索姓名或手机号" @search="onSearch" :show-action="false" style="flex: 1;"></van-search>
                <div class="filter-btn" @click="showFilter = true">
                    <van-icon name="filter-o" size="18"></van-icon>
                    <span>筛选</span>
                </div>
            </div>
            <div class="tab-section">
                <van-tabs v-model:active="currentStatusIndex" @change="onStatusChange" color="#ee0a24" :swipeable="false">
                    <van-tab title="全部" name="0"></van-tab>
                    <van-tab title="单身" name="1"></van-tab>
                    <van-tab title="匹配中" name="2"></van-tab>
                    <van-tab title="已匹配" name="3"></van-tab>
                </van-tabs>
            </div>
        </div>

        <div class="client-list">
            <div v-if="loading" style="text-align: center; padding: 40px;">
                <van-loading size="24px">加载中...</van-loading>
            </div>
            <div v-else-if="clientList.length === 0" style="text-align: center; padding: 40px; color: #999;">
                <van-empty description="暂无客户数据"></van-empty>
            </div>
            <div v-else>
                <div class="client-card" v-for="item in clientList" :key="item.id" @click="goDetail(item.id)">
                    <div class="card-header">
                        <img :src="getCoverImage(item)" alt="">
                        <div class="status-badge" v-if="item.status === 2">匹配中</div>
                        <div class="gender-dot" :class="item.gender === 1 ? 'male' : 'female'"></div>
                    </div>
                    <div class="card-body">
                        <div class="name-row">
                            <span class="name">{{ item.name }}</span>
                            <span style="font-size: 12px; color: #969799;">{{ getAgeText(item) }}</span>
                        </div>
                        <div class="info-tags">
                            <span class="mini-tag">{{ item.height }}cm</span>
                            <span class="mini-tag">{{ getEducationText(item.education) }}</span>
                            <span class="mini-tag">{{ item.profession || '未知职业' }}</span>
                        </div>
                    </div>
                </div>
                <van-loading v-if="loadingMore" size="24px" style="text-align: center; padding: 16px;">加载中...</van-loading>
                <div v-if="!hasMore && clientList.length > 0" style="text-align: center; padding: 16px; color: #999; font-size: 12px;">没有更多了</div>
            </div>
        </div>

        <van-tabbar v-model="active" active-color="#ee0a24">
            <van-tabbar-item icon="home-o" url="index.html">工作台</van-tabbar-item>
            <van-tabbar-item icon="friends-o">客户池</van-tabbar-item>
            <van-tabbar-item icon="add-o" url="client-create.html">录入</van-tabbar-item>
            <van-tabbar-item icon="chat-o" url="templates.html">话术</van-tabbar-item>
        </van-tabbar>

        <van-popup v-model:show="showFilter" position="right" style="width: 80%; height: 100%;">
            <van-nav-bar title="高级筛选" left-text="重置" right-text="确定" @click-left="resetFilter" @click-right="applyFilter"></van-nav-bar>
            <div class="filter-content">
                <div class="filter-group">
                    <div class="filter-title">性别</div>
                    <div class="tag-group">
                        <div class="tag-item" :class="{active: filterForm.gender === 0}" @click="filterForm.gender = 0">全部</div>
                        <div class="tag-item" :class="{active: filterForm.gender === 1}" @click="filterForm.gender = 1">男</div>
                        <div class="tag-item" :class="{active: filterForm.gender === 2}" @click="filterForm.gender = 2">女</div>
                    </div>
                </div>

                <div class="filter-group">
                    <div class="filter-title">年龄 (岁)</div>
                    <div class="range-box">
                        <van-field v-model="filterForm.min_age" type="number" placeholder="最小" style="flex: 1;"></van-field>
                        <span>-</span>
                        <van-field v-model="filterForm.max_age" type="number" placeholder="最大" style="flex: 1;"></van-field>
                    </div>
                </div>

                <div class="filter-group">
                    <div class="filter-title">身高 (cm)</div>
                    <div class="range-box">
                        <van-field v-model="filterForm.min_height" type="number" placeholder="最小" style="flex: 1;"></van-field>
                        <span>-</span>
                        <van-field v-model="filterForm.max_height" type="number" placeholder="最大" style="flex: 1;"></van-field>
                    </div>
                </div>

                <div class="filter-group">
                    <div class="filter-title">最低学历</div>
                    <div class="tag-group">
                        <div class="tag-item" :class="{active: filterForm.education === 0}" @click="filterForm.education = 0">不限</div>
                        <div class="tag-item" :class="{active: filterForm.education === 2}" @click="filterForm.education = 2">大专</div>
                        <div class="tag-item" :class="{active: filterForm.education === 3}" @click="filterForm.education = 3">本科</div>
                        <div class="tag-item" :class="{active: filterForm.education === 4}" @click="filterForm.education = 4">硕士</div>
                    </div>
                </div>

                <div class="filter-group">
                    <div class="filter-title">婚姻状况</div>
                    <div class="tag-group">
                        <div class="tag-item" :class="{active: filterForm.marital_status === 0}" @click="filterForm.marital_status = 0">不限</div>
                        <div class="tag-item" :class="{active: filterForm.marital_status === 1}" @click="filterForm.marital_status = 1">未婚</div>
                        <div class="tag-item" :class="{active: filterForm.marital_status === 2}" @click="filterForm.marital_status = 2">已婚</div>
                        <div class="tag-item" :class="{active: filterForm.marital_status === 3}" @click="filterForm.marital_status = 3">离异</div>
                    </div>
                </div>

                <div class="filter-group">
                    <div class="filter-title">工作城市</div>
                    <van-field v-model="filterForm.work_city" placeholder="请输入城市名称"></van-field>
                </div>
            </div>
        </van-popup>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted } = Vue;

        createApp({
            setup() {
                const active = ref(1);
                const keyword = ref('');
                const showFilter = ref(false);
                const currentStatusIndex = ref('0');
                const clientList = ref([]);
                const loading = ref(false);
                const loadingMore = ref(false);
                const hasMore = ref(true);
                const page = ref(1);
                const pageSize = 10;

                const filterForm = reactive({
                    gender: 0,
                    min_age: '',
                    max_age: '',
                    min_height: '',
                    max_height: '',
                    education: 0,
                    min_income: '',
                    marital_status: 0,
                    work_city: ''
                });

                const token = localStorage.getItem('token');
                const api = axios.create({
                    baseURL: '/api',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                const getAgeText = (item) => {
                    if (item.age) return item.age + '岁';
                    if (item.birthday) {
                        const year = parseInt(item.birthday.substring(0, 4));
                        const currentYear = new Date().getFullYear();
                        return (currentYear - year) + '岁';
                    }
                    return '未知年龄';
                };

                const getEducationText = (level) => {
                    const map = { 1: '高中', 2: '大专', 3: '本科', 4: '硕士', 5: '博士' };
                    return map[level] || '未知';
                };

                const getCoverImage = (item) => {
                    if (item.photos) {
                        try {
                            const photos = JSON.parse(item.photos);
                            if (photos.length > 0) return photos[0];
                        } catch (e) {}
                    }
                    if (item.avatar) return item.avatar;
                    return `https://api.dicebear.com/7.x/avataaars/svg?seed=${item.id}`;
                };

                const fetchData = async (reset = false) => {
                    if (reset) {
                        page.value = 1;
                        clientList.value = [];
                        hasMore.value = true;
                    }

                    if (!hasMore.value) return;

                    loadingMore.value = page.value === 1;

                    try {
                        const params = {
                            page: page.value,
                            page_size: pageSize,
                            name: keyword.value || undefined,
                            status: currentStatusIndex.value === '0' ? undefined : parseInt(currentStatusIndex.value),
                            gender: filterForm.gender || undefined,
                            min_age: filterForm.min_age || undefined,
                            max_age: filterForm.max_age || undefined,
                            min_height: filterForm.min_height || undefined,
                            max_height: filterForm.max_height || undefined,
                            education: filterForm.education || undefined,
                            marital_status: filterForm.marital_status || undefined,
                            work_city: filterForm.work_city || undefined
                        };

                        const res = await api.get('/clients/list', { params });
                        const list = res.data.data?.list || [];

                        if (list.length < pageSize) {
                            hasMore.value = false;
                        }

                        if (reset) {
                            clientList.value = list;
                        } else {
                            clientList.value = [...clientList.value, ...list];
                        }
                        page.value++;
                    } catch (e) {
                        console.error(e);
                    } finally {
                        loading.value = false;
                        loadingMore.value = false;
                    }
                };

                const onSearch = () => {
                    fetchData(true);
                };

                const onStatusChange = () => {
                    fetchData(true);
                };

                const resetFilter = () => {
                    filterForm.gender = 0;
                    filterForm.min_age = '';
                    filterForm.max_age = '';
                    filterForm.min_height = '';
                    filterForm.max_height = '';
                    filterForm.education = 0;
                    filterForm.marital_status = 0;
                    filterForm.work_city = '';
                };

                const applyFilter = () => {
                    showFilter.value = false;
                    fetchData(true);
                };

                const goDetail = (id) => {
                    window.location.href = `client-detail.html?id=${id}`;
                };

                const handleScroll = () => {
                    const scrollTop = window.scrollY;
                    const windowHeight = window.innerHeight;
                    const documentHeight = document.documentElement.scrollHeight;

                    if (scrollTop + windowHeight >= documentHeight - 100) {
                        if (!loadingMore.value && hasMore.value) {
                            fetchData();
                        }
                    }
                };

                onMounted(() => {
                    fetchData();
                    window.addEventListener('scroll', handleScroll);
                });

                return {
                    active,
                    keyword,
                    showFilter,
                    currentStatusIndex,
                    clientList,
                    loading,
                    loadingMore,
                    hasMore,
                    filterForm,
                    getAgeText,
                    getEducationText,
                    getCoverImage,
                    onSearch,
                    onStatusChange,
                    resetFilter,
                    applyFilter,
                    goDetail
                };
            }
        }).use(vant).mount('#app');
    </script>
</body>
</html>
